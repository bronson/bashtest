#!/bin/bash

# These tests verify the various ways to launch tests.
# Other command-line arguments are tested elsewhere.


# TODO: test missing file or directory names on the command line
# TODO: test what happens when I specify the same file multiple times
# TODO: what about mocking run-tests so I don't need to $run_tests?
    # but only do it when I can do one mock for all tests

before:all() {
    # this is a little more readable
    run_tests="$tsk_framework_file"
}

test:run_one_testfile() {
    cd "$(framework_dir)/fixtures/numbered"
    $run_tests one.test -f test
    stdout_is <<EOF
pass test:one
EOF
}

test:run_multiple_testfiles() {
    # tests and testfiles are run in indeterminate order so we need to sort the output
    cd "$(framework_dir)/fixtures/numbered"
    $run_tests one.test two.test three.test --formatter=test | sort
    stdout_is <<EOF
pass test:one
pass test:three
pass test:two
EOF
}

test:run_one_dir() {
    cd "$(framework_dir)/fixtures"
    $run_tests numbered -f test | sort
    stdout_is <<EOF
pass test:one
pass test:three
pass test:two
EOF
}

test:launch_one_testfile() {
    cd "$(framework_dir)/fixtures/numbered"
    ./one.test -f test
    stdout_is <<EOF
pass test:one
EOF
}

test:launch_multiple_testfiles() {
    cd "$(framework_dir)/fixtures/numbered"
    ./one.test two.test three.test -f test | sort
    stdout_is <<EOF
pass test:one
pass test:three
pass test:two
EOF
}

test:launch_testfiles_and_dirs() {
    cd "$(framework_dir)/fixtures/numbered"
    ./one.test ../lettered two.test -f test | sort
    stdout_is <<EOF
pass test:a
pass test:b
pass test:c
pass test:one
pass test:two
EOF
}

test:run_multiple_dirs() {
    cd "$(framework_dir)/fixtures"
    $run_tests lettered numbered -f test | sort
    stdout_is <<EOF
pass test:a
pass test:b
pass test:c
pass test:one
pass test:three
pass test:two
EOF
}

skip:execute_stdio() {
    bash $tsk_framework_file - -f test <<EOL
        test:run_test() { is_eq 1 1; }
EOL
}

skip:execute_stdio_multiple() {
    bash $tsk_framework_file one.test - <<EOL
        test:run_test() { is_eq 1 1; }
EOL
}

source "$(dirname "$BASH_SOURCE")/run-tests"
