#!/bin/bash

# allows for nicer syntax: now tests can "run_tests testfile"
run_tests() {
    export TSK_ROOT_DIR="$tsk_root_dir/run/bashtest"  # TODO: bad use of tsk_root_dir
    create_dir "$TSK_ROOT_DIR"    # directory is automatically cleaned up
    "$tsk_framework_file" "$@"
}

# Verify the before/after hooks.

test:hooks() {
    # create a testfile that writes to a file when the hooks
    # are called
    create_file the.test <<'EOF'
        # opsfile is supplied by the calling test

        before:all() {
            echo "before all" >> "$opsfile"
        }

        after:all() {
            echo "after all" >> "$opsfile"
        }

        before:each() {
            echo "before each $1" >> "$opsfile"
        }

        after:each() {
            echo "after each $1" >>  "$opsfile"
        }

        test:one() {
            echo "test $1" >> "$opsfile"
            is_eq 1 1 # ensure test passes (TODO: this should be unncessary)
        }
EOF

    # TODO: how can I avoid leaking this variable into subsequent tests?
    export opsfile="$(test_dir)/opsfile"
    run_tests the.test
    file_is '' "$opsfile" <<EOF
before all
before each test:one
test test:one
after each test:one
after all
EOF
    rm "$opsfile"
}

source "$(dirname "$BASH_SOURCE")/run-tests"
