#!/bin/bash

# This testfile verifies the environment the tests are run in


run_tests() {
    export TSK_ROOT_DIR="$tsk_root_dir/run/bashtest"  # TODO: bad use of tsk_root_dir
    create_dir "$TSK_ROOT_DIR"    # directory is automatically cleaned up
    "$tsk_framework_file" "$@"
}


# every test must start in test_dir
test:test_dir() {
    is_eq "$(pwd)" "$(test_dir)"
}

# the before:each hook must start in test_dir
test:test_dir_in_before_each() {
    create_file dir.test <<'EOF'
      : before:each() {
      :     is_eq "$(pwd)" "$(test_dir)"
      : }
      : test:working_dir() {
      :     is_eq "$(pwd)" "$(test_dir)"
      : }
EOF
    run_tests -f test | sort
    stdout_is <<EOF
pass test:working_dir
EOF
}

# TODO: what are the cwds for before:all and after:all?

# it's fine for tests to change directories, but ensure that
# the directory is restored properly when the next test is run
skikp:directory_is_set_for_each_test() {
    cat > dir.test <<EOF
test:1() {
}

test:2() {
    cd /tmp
    is_eq "$(pwd)" "/tmp"
}

test:3() {
    is_eq "$(pwd)" "/tmp"
}
EOF

    run_tests - -f test <<EOF | sort
EOF
}

source "$(dirname "$BASH_SOURCE")/run-tests"
